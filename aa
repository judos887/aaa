pcall(function()
    for _, v in ipairs(game.CoreGui:GetChildren()) do
        if v.Name == "SchmecktPvP" then v:Destroy() end
    end
end)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local HttpService = game:GetService("HttpService")
local LocalPlayer = Players.LocalPlayer

local SaveFileName = "SchmecktPvP_Settings.json"
local AllConnections = {}

local function TrackConnection(conn)
    table.insert(AllConnections, conn)
    return conn
end

local function CleanupAllConnections()
    for _, conn in ipairs(AllConnections) do
        pcall(function() conn:Disconnect() end)
    end
    AllConnections = {}
end

local function LoadSettings()
    local success, result = pcall(function()
        if readfile then
            return HttpService:JSONDecode(readfile(SaveFileName))
        end
    end)
    if success and result then return result end
    return {}
end

local function SaveSettings(settings)
    pcall(function()
        if writefile then
            writefile(SaveFileName, HttpService:JSONEncode(settings))
        end
    end)
end

local SavedSettings = LoadSettings()
local ScaleFactor = 1
local SelectedVersion = nil

local AutoGrabEnabled = false
local AutoGrabRange = 5
local GrabStartTime = 0
local CurrentGrabPrompt = nil

local WalkFlingRunning = false
local FlingConnection = nil
local CollisionConnection = nil

local AntiRagdollActive = false
local AntiRagdollConnections = {}
local trackedMotors = {}

local AntiKnockbackActive = false
local AntiKnockbackConnection = nil
local HitboxConnection = nil

local FloatStealEnabled = false
local FloatPlatform = nil
local FloatConnection = nil
local IsCurrentlyFloating = false
local FloatStealStartTime = 0
local OriginalGroundY = nil

local FloatHeight = 13
local FloatHeightNearBase = 11
local BaseProximityRange = 20
local SmartFloatRange = 30
local FloatStartDelay = 0.5

local SpeedBoostEnabled = false
local NormalSpeed = SavedSettings.NormalSpeed or 57
local StealSpeed = SavedSettings.StealSpeed or 29.5

local AutoBatEnabled = false
local BatSpamDelay = 0.05

local SetWalkFling, SetTweenPanel, SetAutoGrab
local GetWalkFling, GetTweenPanel, GetAutoGrabFunc, GetFloatSteal, GetSpeedBoost, GetHitboxExp, GetAutoBat, GetAntiRagdoll, GetAntiKnockback
local ScreenGui, StatusLabel, ProgFill, ProgPercent, SpeedFrame, SpeedStatusLabel

local function GetMyPlot()
    local plots = Workspace:FindFirstChild("Plots")
    if not plots then return nil end
    for _, plot in pairs(plots:GetChildren()) do
        for _, obj in pairs(plot:GetDescendants()) do
            if obj:IsA("TextLabel") and obj.Text then
                if obj.Text:find(LocalPlayer.Name) or obj.Text:find(LocalPlayer.DisplayName) then
                    return plot
                end
            end
        end
    end
    return nil
end

local function GetMyAnimalTarget()
    local myPlot = GetMyPlot()
    if not myPlot then return nil end
    local animalTarget = myPlot:FindFirstChild("AnimalTarget")
    if animalTarget and animalTarget:IsA("BasePart") then
        return animalTarget.Position
    end
    return nil
end

local function GetDistanceToBase(hrp)
    local basePos = GetMyAnimalTarget()
    if not basePos then return math.huge end
    return (Vector3.new(hrp.Position.X, 0, hrp.Position.Z) - Vector3.new(basePos.X, 0, basePos.Z)).Magnitude
end

local function GetRealGroundY(hrp)
    local rayParams = RaycastParams.new()
    rayParams.FilterType = Enum.RaycastFilterType.Exclude
    local filterList = {LocalPlayer.Character}
    if FloatPlatform then table.insert(filterList, FloatPlatform) end
    rayParams.FilterDescendantsInstances = filterList
    
    local result = Workspace:Raycast(hrp.Position, Vector3.new(0, -200, 0), rayParams)
    if result then
        return result.Position.Y
    end
    return hrp.Position.Y - 3
end

local function GetCurrentFloatHeight(hrp)
    local distToBase = GetDistanceToBase(hrp)
    if distToBase <= BaseProximityRange then
        return FloatHeightNearBase
    end
    return FloatHeight
end

local function ShowVersionSelector()
    local SelectorGui = Instance.new("ScreenGui")
    SelectorGui.Name = "SchmecktVersionSelector"
    SelectorGui.ResetOnSpawn = false
    SelectorGui.Parent = game.CoreGui

    local SelectorFrame = Instance.new("Frame")
    SelectorFrame.Size = UDim2.new(0, 300, 0, 150)
    SelectorFrame.Position = UDim2.new(0.5, -150, 0.5, -75)
    SelectorFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
    SelectorFrame.BorderSizePixel = 0
    SelectorFrame.Parent = SelectorGui
    Instance.new("UICorner", SelectorFrame).CornerRadius = UDim.new(0, 10)
    Instance.new("UIStroke", SelectorFrame).Color = Color3.fromRGB(138, 43, 226)

    local TitleLabel = Instance.new("TextLabel")
    TitleLabel.Size = UDim2.new(1, 0, 0, 40)
    TitleLabel.Position = UDim2.new(0, 0, 0, 10)
    TitleLabel.BackgroundTransparency = 1
    TitleLabel.Text = "Select Version"
    TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    TitleLabel.Font = Enum.Font.GothamBold
    TitleLabel.TextSize = 20
    TitleLabel.Parent = SelectorFrame

    local PCButton = Instance.new("TextButton")
    PCButton.Size = UDim2.new(0, 120, 0, 50)
    PCButton.Position = UDim2.new(0, 25, 0, 70)
    PCButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    PCButton.Text = "PC Version"
    PCButton.TextColor3 = Color3.fromRGB(180, 100, 255)
    PCButton.Font = Enum.Font.GothamBold
    PCButton.TextSize = 16
    PCButton.Parent = SelectorFrame
    Instance.new("UICorner", PCButton).CornerRadius = UDim.new(0, 8)
    Instance.new("UIStroke", PCButton).Color = Color3.fromRGB(138, 43, 226)

    local MobileButton = Instance.new("TextButton")
    MobileButton.Size = UDim2.new(0, 120, 0, 50)
    MobileButton.Position = UDim2.new(0, 155, 0, 70)
    MobileButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    MobileButton.Text = "Mobile Version"
    MobileButton.TextColor3 = Color3.fromRGB(180, 100, 255)
    MobileButton.Font = Enum.Font.GothamBold
    MobileButton.TextSize = 16
    MobileButton.Parent = SelectorFrame
    Instance.new("UICorner", MobileButton).CornerRadius = UDim.new(0, 8)
    Instance.new("UIStroke", MobileButton).Color = Color3.fromRGB(138, 43, 226)

    local Selected = false

    PCButton.MouseButton1Click:Connect(function()
        if Selected then return end
        Selected = true
        ScaleFactor = 1
        SelectedVersion = "PC"
        SelectorGui:Destroy()
    end)

    MobileButton.MouseButton1Click:Connect(function()
        if Selected then return end
        Selected = true
        ScaleFactor = 1 / 2.3
        SelectedVersion = "Mobile"
        SelectorGui:Destroy()
    end)

    repeat task.wait() until SelectedVersion ~= nil
end

ShowVersionSelector()

ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "SchmecktPvP"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = game.CoreGui

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 260 * ScaleFactor, 0, 400 * ScaleFactor)
MainFrame.Position = UDim2.new(1, -280 * ScaleFactor, 0, 120 * ScaleFactor)
MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 8 * ScaleFactor)
Instance.new("UIStroke", MainFrame).Color = Color3.fromRGB(138, 43, 226)

local TopBar = Instance.new("Frame")
TopBar.Size = UDim2.new(1, 0, 0, 32 * ScaleFactor)
TopBar.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
TopBar.BorderSizePixel = 0
TopBar.Parent = MainFrame
Instance.new("UICorner", TopBar).CornerRadius = UDim.new(0, 8 * ScaleFactor)
Instance.new("UIStroke", TopBar).Color = Color3.fromRGB(138, 43, 226)

local Title = Instance.new("TextLabel")
Title.Text = "Schmeckt PvP | .gg/schmeckt"
Title.Font = Enum.Font.GothamBold
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 13 * ScaleFactor
Title.BackgroundTransparency = 1
Title.Size = UDim2.new(1, -40 * ScaleFactor, 1, 0)
Title.Position = UDim2.new(0, 10 * ScaleFactor, 0, 0)
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.Parent = TopBar

local CloseButton = Instance.new("TextButton")
CloseButton.Text = "X"
CloseButton.Font = Enum.Font.GothamBold
CloseButton.TextSize = 16 * ScaleFactor
CloseButton.TextColor3 = Color3.fromRGB(255, 60, 60)
CloseButton.BackgroundTransparency = 1
CloseButton.Size = UDim2.new(0, 30 * ScaleFactor, 0, 30 * ScaleFactor)
CloseButton.Position = UDim2.new(1, -32 * ScaleFactor, 0, 1 * ScaleFactor)
CloseButton.Parent = TopBar

local function CreateToggle(parent, text, yPos, settingKey, defaultState, forceDefault)
    local Container = Instance.new("Frame", parent)
    Container.Size = UDim2.new(1, -20 * ScaleFactor, 0, 38 * ScaleFactor)
    Container.Position = UDim2.new(0, 10 * ScaleFactor, 0, yPos * ScaleFactor)
    Container.BackgroundTransparency = 1

    local Label = Instance.new("TextLabel", Container)
    Label.Text = text
    Label.Font = Enum.Font.GothamBold
    Label.TextColor3 = Color3.fromRGB(255, 255, 255)
    Label.TextSize = 14 * ScaleFactor
    Label.BackgroundTransparency = 1
    Label.Size = UDim2.new(1, -60 * ScaleFactor, 1, 0)
    Label.TextXAlignment = Enum.TextXAlignment.Left

    local SwitchBg = Instance.new("Frame", Container)
    SwitchBg.Size = UDim2.new(0, 36 * ScaleFactor, 0, 18 * ScaleFactor)
    SwitchBg.Position = UDim2.new(1, -46 * ScaleFactor, 0.5, -9 * ScaleFactor)
    SwitchBg.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    Instance.new("UICorner", SwitchBg).CornerRadius = UDim.new(1, 0)

    local Knob = Instance.new("Frame", SwitchBg)
    Knob.Size = UDim2.new(0, 14 * ScaleFactor, 0, 14 * ScaleFactor)
    Knob.Position = UDim2.new(0, 2 * ScaleFactor, 0.5, -7 * ScaleFactor)
    Knob.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
    Instance.new("UICorner", Knob).CornerRadius = UDim.new(1, 0)

    local Separator = Instance.new("Frame", parent)
    Separator.Size = UDim2.new(1, -20 * ScaleFactor, 0, 1 * ScaleFactor)
    Separator.Position = UDim2.new(0, 10 * ScaleFactor, 0, (yPos + 38) * ScaleFactor)
    Separator.BackgroundColor3 = Color3.fromRGB(138, 43, 226)

    local toggled
    if forceDefault then
        toggled = defaultState or false
    else
        toggled = (settingKey and SavedSettings[settingKey] ~= nil) and SavedSettings[settingKey] or defaultState or false
    end

    local function updateVisual()
        if toggled then
            Knob.Position = UDim2.new(1, -16 * ScaleFactor, 0.5, -7 * ScaleFactor)
            Knob.BackgroundColor3 = Color3.fromRGB(180, 100, 255)
            SwitchBg.BackgroundColor3 = Color3.fromRGB(100, 50, 150)
        else
            Knob.Position = UDim2.new(0, 2 * ScaleFactor, 0.5, -7 * ScaleFactor)
            Knob.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
            SwitchBg.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        end
    end

    local function setToggle(state)
        toggled = state
        updateVisual()
        if settingKey and not forceDefault then
            SavedSettings[settingKey] = toggled
            SaveSettings(SavedSettings)
        end
    end

    updateVisual()

    SwitchBg.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            setToggle(not toggled)
        end
    end)

    return function() return toggled end, setToggle
end

local GetAntiRagdollFunc, SetAntiRagdoll = CreateToggle(MainFrame, "Anti Ragdoll", 42, "AntiRagdoll", false)
GetAntiRagdoll = GetAntiRagdollFunc
local GetAntiKnockbackFunc, SetAntiKnockback = CreateToggle(MainFrame, "Anti Knockback", 82, "AntiKnockback", false)
GetAntiKnockback = GetAntiKnockbackFunc
local GetWalkFlingFunc, SetWalkFlingFunc = CreateToggle(MainFrame, "WalkFling [Q]", 122, nil, false)
GetWalkFling = GetWalkFlingFunc
SetWalkFling = SetWalkFlingFunc

-- Auto Grab: IMMER deaktiviert starten (forceDefault = true)
local GetAutoGrabFuncTemp, SetAutoGrabFunc = CreateToggle(MainFrame, "Auto Grab", 162, nil, false, true)
GetAutoGrabFunc = GetAutoGrabFuncTemp
SetAutoGrab = SetAutoGrabFunc

-- SetAutoGrab global verfügbar machen für Tween Panel
getgenv().SchmecktSetAutoGrab = SetAutoGrab
getgenv().SchmecktGetAutoGrab = GetAutoGrabFunc

local GetFloatStealFunc, SetFloatSteal = CreateToggle(MainFrame, "Smart Float", 202, "SmartFloat", false)
GetFloatSteal = GetFloatStealFunc
local GetSpeedBoostFunc, SetSpeedBoost = CreateToggle(MainFrame, "Speed Boost", 242, "SpeedBoost", false)
GetSpeedBoost = GetSpeedBoostFunc
local GetHitboxExpFunc, SetHitboxExp = CreateToggle(MainFrame, "Hitbox Expander", 282, "HitboxExpander", false)
GetHitboxExp = GetHitboxExpFunc
local GetAutoBatFunc, SetAutoBat = CreateToggle(MainFrame, "Auto Bat", 322, "AutoBat", false)
GetAutoBat = GetAutoBatFunc
local GetTweenPanelFunc, SetTweenPanelFunc = CreateToggle(MainFrame, "Tween Panel", 362, nil, false)
GetTweenPanel = GetTweenPanelFunc
SetTweenPanel = SetTweenPanelFunc

TrackConnection(UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType ~= Enum.UserInputType.Keyboard then return end
    if input.KeyCode == Enum.KeyCode.Q then
        SetWalkFling(not GetWalkFling())
    end
end))

local ProgressFrame = Instance.new("Frame")
ProgressFrame.Size = UDim2.new(0, 280 * ScaleFactor, 0, 28 * ScaleFactor)
ProgressFrame.Position = UDim2.new(0.5, -140 * ScaleFactor, 0, 14 * ScaleFactor)
ProgressFrame.BackgroundColor3 = Color3.fromRGB(12, 12, 12)
ProgressFrame.BackgroundTransparency = 0.15
ProgressFrame.BorderSizePixel = 0
ProgressFrame.Parent = ScreenGui
Instance.new("UICorner", ProgressFrame).CornerRadius = UDim.new(0, 8 * ScaleFactor)
Instance.new("UIStroke", ProgressFrame).Color = Color3.fromRGB(138, 43, 226)

local ProgLabel = Instance.new("TextLabel")
ProgLabel.Size = UDim2.new(0, 60 * ScaleFactor, 1, 0)
ProgLabel.Position = UDim2.new(0, 6 * ScaleFactor, 0, 0)
ProgLabel.BackgroundTransparency = 1
ProgLabel.Text = "GRAB"
ProgLabel.TextColor3 = Color3.fromRGB(200, 120, 255)
ProgLabel.Font = Enum.Font.GothamBlack
ProgLabel.TextSize = 11 * ScaleFactor
ProgLabel.TextXAlignment = Enum.TextXAlignment.Left
ProgLabel.Parent = ProgressFrame

StatusLabel = Instance.new("TextLabel")
StatusLabel.Size = UDim2.new(0, 80 * ScaleFactor, 1, 0)
StatusLabel.Position = UDim2.new(0, 48 * ScaleFactor, 0, 0)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "Disabled"
StatusLabel.TextColor3 = Color3.fromRGB(255, 60, 60)
StatusLabel.Font = Enum.Font.GothamBold
StatusLabel.TextSize = 10 * ScaleFactor
StatusLabel.TextXAlignment = Enum.TextXAlignment.Left
StatusLabel.Parent = ProgressFrame

local ProgBarBg = Instance.new("Frame")
ProgBarBg.Size = UDim2.new(0.55, 0, 0, 10 * ScaleFactor)
ProgBarBg.Position = UDim2.new(0.38, 0, 0.5, -5 * ScaleFactor)
ProgBarBg.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
ProgBarBg.BorderSizePixel = 0
ProgBarBg.Parent = ProgressFrame
Instance.new("UICorner", ProgBarBg).CornerRadius = UDim.new(1, 0)
Instance.new("UIStroke", ProgBarBg).Color = Color3.fromRGB(60, 60, 60)

ProgFill = Instance.new("Frame")
ProgFill.Size = UDim2.new(0, 0, 1, 0)
ProgFill.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
ProgFill.BorderSizePixel = 0
ProgFill.Parent = ProgBarBg
Instance.new("UICorner", ProgFill).CornerRadius = UDim.new(1, 0)
Instance.new("UIGradient", ProgFill).Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(138, 43, 226)),
    ColorSequenceKeypoint.new(0.5, Color3.fromRGB(220, 150, 255)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(138, 43, 226))
}

ProgPercent = Instance.new("TextLabel")
ProgPercent.Size = UDim2.new(0, 35 * ScaleFactor, 1, 0)
ProgPercent.Position = UDim2.new(0.94, -35 * ScaleFactor, 0, 0)
ProgPercent.BackgroundTransparency = 1
ProgPercent.Text = "0%"
ProgPercent.TextColor3 = Color3.fromRGB(255, 255, 255)
ProgPercent.Font = Enum.Font.GothamBold
ProgPercent.TextSize = 10 * ScaleFactor
ProgPercent.TextXAlignment = Enum.TextXAlignment.Right
ProgPercent.Parent = ProgressFrame

SpeedFrame = Instance.new("Frame")
SpeedFrame.Size = UDim2.new(0, 200 * ScaleFactor, 0, 70 * ScaleFactor)
SpeedFrame.Position = UDim2.new(1, -220 * ScaleFactor, 1, -90 * ScaleFactor)
SpeedFrame.BackgroundColor3 = Color3.fromRGB(12, 12, 12)
SpeedFrame.BorderSizePixel = 0
SpeedFrame.Visible = false
SpeedFrame.Active = true
SpeedFrame.Draggable = true
SpeedFrame.Parent = ScreenGui
Instance.new("UICorner", SpeedFrame).CornerRadius = UDim.new(0, 8 * ScaleFactor)
Instance.new("UIStroke", SpeedFrame).Color = Color3.fromRGB(138, 43, 226)

local SpeedTitle = Instance.new("TextLabel", SpeedFrame)
SpeedTitle.Size = UDim2.new(1, 0, 0, 20 * ScaleFactor)
SpeedTitle.Position = UDim2.new(0, 0, 0, 5 * ScaleFactor)
SpeedTitle.BackgroundTransparency = 1
SpeedTitle.Text = "Speed Boost"
SpeedTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
SpeedTitle.Font = Enum.Font.GothamBold
SpeedTitle.TextSize = 12 * ScaleFactor

local SpeedNormalLabel = Instance.new("TextLabel", SpeedFrame)
SpeedNormalLabel.Size = UDim2.new(0, 45 * ScaleFactor, 0, 20 * ScaleFactor)
SpeedNormalLabel.Position = UDim2.new(0, 10 * ScaleFactor, 0, 28 * ScaleFactor)
SpeedNormalLabel.BackgroundTransparency = 1
SpeedNormalLabel.Text = "Normal"
SpeedNormalLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
SpeedNormalLabel.Font = Enum.Font.Gotham
SpeedNormalLabel.TextSize = 10 * ScaleFactor
SpeedNormalLabel.TextXAlignment = Enum.TextXAlignment.Left

local SpeedNormalBox = Instance.new("TextBox", SpeedFrame)
SpeedNormalBox.Size = UDim2.new(0, 40 * ScaleFactor, 0, 18 * ScaleFactor)
SpeedNormalBox.Position = UDim2.new(0, 55 * ScaleFactor, 0, 29 * ScaleFactor)
SpeedNormalBox.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
SpeedNormalBox.Text = tostring(NormalSpeed)
SpeedNormalBox.TextColor3 = Color3.fromRGB(255, 255, 255)
SpeedNormalBox.Font = Enum.Font.Gotham
SpeedNormalBox.TextSize = 11 * ScaleFactor
SpeedNormalBox.ClearTextOnFocus = false
Instance.new("UICorner", SpeedNormalBox).CornerRadius = UDim.new(0, 4 * ScaleFactor)

local SpeedStealLabel = Instance.new("TextLabel", SpeedFrame)
SpeedStealLabel.Size = UDim2.new(0, 30 * ScaleFactor, 0, 20 * ScaleFactor)
SpeedStealLabel.Position = UDim2.new(0, 105 * ScaleFactor, 0, 28 * ScaleFactor)
SpeedStealLabel.BackgroundTransparency = 1
SpeedStealLabel.Text = "Steal"
SpeedStealLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
SpeedStealLabel.Font = Enum.Font.Gotham
SpeedStealLabel.TextSize = 10 * ScaleFactor
SpeedStealLabel.TextXAlignment = Enum.TextXAlignment.Left

local SpeedStealBox = Instance.new("TextBox", SpeedFrame)
SpeedStealBox.Size = UDim2.new(0, 40 * ScaleFactor, 0, 18 * ScaleFactor)
SpeedStealBox.Position = UDim2.new(0, 140 * ScaleFactor, 0, 29 * ScaleFactor)
SpeedStealBox.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
SpeedStealBox.Text = tostring(StealSpeed)
SpeedStealBox.TextColor3 = Color3.fromRGB(255, 255, 255)
SpeedStealBox.Font = Enum.Font.Gotham
SpeedStealBox.TextSize = 11 * ScaleFactor
SpeedStealBox.ClearTextOnFocus = false
Instance.new("UICorner", SpeedStealBox).CornerRadius = UDim.new(0, 4 * ScaleFactor)

SpeedStatusLabel = Instance.new("TextLabel", SpeedFrame)
SpeedStatusLabel.Size = UDim2.new(1, -20 * ScaleFactor, 0, 16 * ScaleFactor)
SpeedStatusLabel.Position = UDim2.new(0, 10 * ScaleFactor, 0, 50 * ScaleFactor)
SpeedStatusLabel.BackgroundTransparency = 1
SpeedStatusLabel.Text = "NORMAL - " .. tostring(NormalSpeed)
SpeedStatusLabel.TextColor3 = Color3.fromRGB(0, 200, 100)
SpeedStatusLabel.Font = Enum.Font.GothamBold
SpeedStatusLabel.TextSize = 10 * ScaleFactor
SpeedStatusLabel.TextXAlignment = Enum.TextXAlignment.Left

SpeedNormalBox.FocusLost:Connect(function()
    local num = tonumber(SpeedNormalBox.Text)
    if num and num > 0 then
        NormalSpeed = num
        SavedSettings.NormalSpeed = num
        SaveSettings(SavedSettings)
    else
        SpeedNormalBox.Text = tostring(NormalSpeed)
    end
end)

SpeedStealBox.FocusLost:Connect(function()
    local num = tonumber(SpeedStealBox.Text)
    if num and num > 0 then
        StealSpeed = num
        SavedSettings.StealSpeed = num
        SaveSettings(SavedSettings)
    else
        SpeedStealBox.Text = tostring(StealSpeed)
    end
end)

local function KillWalkFling()
    if FlingConnection then FlingConnection:Disconnect() FlingConnection = nil end
    if CollisionConnection then CollisionConnection:Disconnect() CollisionConnection = nil end
    WalkFlingRunning = false
end

local function StartWalkFling()
    if WalkFlingRunning then return end
    local character = LocalPlayer.Character
    if not character then return end
    local root = character:FindFirstChild("HumanoidRootPart")
    local humanoid = character:FindFirstChild("Humanoid")
    if not root or not humanoid then return end
    WalkFlingRunning = true

    CollisionConnection = RunService.Stepped:Connect(function()
        for _, plr in ipairs(Players:GetPlayers()) do
            if plr ~= LocalPlayer and plr.Character then
                for _, part in ipairs(plr.Character:GetChildren()) do
                    if part:IsA("BasePart") then part.CanCollide = false end
                end
            end
        end
    end)

    FlingConnection = RunService.Heartbeat:Connect(function()
        character = LocalPlayer.Character
        root = character and character:FindFirstChild("HumanoidRootPart")
        humanoid = character and character:FindFirstChild("Humanoid")
        if not (character and character.Parent and root and root.Parent and humanoid) then return end
        local moveDir = humanoid.MoveDirection
        local currentVel = root.Velocity
        root.Velocity = Vector3.new(0, 10000, 0)
        RunService.RenderStepped:Wait()
        if character and character.Parent and root and root.Parent then
            if moveDir.Magnitude > 0.1 then
                root.Velocity = Vector3.new(moveDir.X * 60, currentVel.Y, moveDir.Z * 60)
            else
                root.Velocity = Vector3.new(0, currentVel.Y, 0)
            end
        end
    end)
end

local function EnableAntiRagdoll()
    if AntiRagdollActive then return end
    AntiRagdollActive = true
    local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local humanoid = character:WaitForChild("Humanoid")

    local function WatchMotor(motor)
        if not motor:IsA("Motor6D") or trackedMotors[motor] then return end
        trackedMotors[motor] = true
        table.insert(AntiRagdollConnections, motor:GetPropertyChangedSignal("Enabled"):Connect(function()
            if not motor.Enabled then motor.Enabled = true end
        end))
        motor.Enabled = true
    end

    for _, desc in ipairs(character:GetDescendants()) do WatchMotor(desc) end
    table.insert(AntiRagdollConnections, character.DescendantAdded:Connect(WatchMotor))

    table.insert(AntiRagdollConnections, RunService.Heartbeat:Connect(function()
        for _, obj in pairs(character:GetDescendants()) do
            if obj:IsA("BallSocketConstraint") or obj:IsA("NoCollisionConstraint") or obj:IsA("HingeConstraint") then
                obj:Destroy()
            end
        end
        local state = humanoid:GetState()
        if state == Enum.HumanoidStateType.Physics or state == Enum.HumanoidStateType.Ragdoll or state == Enum.HumanoidStateType.FallingDown then
            humanoid:ChangeState(Enum.HumanoidStateType.Running)
        end
    end))

    table.insert(AntiRagdollConnections, LocalPlayer.CharacterAdded:Connect(function(newChar)
        humanoid = newChar:WaitForChild("Humanoid")
        trackedMotors = {}
    end))
end

local function DisableAntiRagdoll()
    AntiRagdollActive = false
    for _, conn in pairs(AntiRagdollConnections) do conn:Disconnect() end
    AntiRagdollConnections = {}
    trackedMotors = {}
end

local function EnableAntiKnockback()
    if AntiKnockbackActive then return end
    AntiKnockbackActive = true
    AntiKnockbackConnection = RunService.Heartbeat:Connect(function()
        local character = LocalPlayer.Character
        if not character then return end
        local hrp = character:FindFirstChild("HumanoidRootPart")
        local humanoid = character:FindFirstChild("Humanoid")
        if not hrp or not humanoid then return end
        local state = humanoid:GetState()
        if state == Enum.HumanoidStateType.Physics or state == Enum.HumanoidStateType.Ragdoll then return end
        local vel = hrp.AssemblyLinearVelocity
        local hs = Vector3.new(vel.X, 0, vel.Z).Magnitude
        if hs > 50 then
            local dir = Vector3.new(vel.X, 0, vel.Z).Unit
            hrp.AssemblyLinearVelocity = Vector3.new(dir.X * 50, vel.Y, dir.Z * 50)
        end
    end)
end

local function DisableAntiKnockback()
    AntiKnockbackActive = false
    if AntiKnockbackConnection then AntiKnockbackConnection:Disconnect() AntiKnockbackConnection = nil end
end

local function GetNearestPlayerDistance(hrp)
    local minDist = math.huge
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            local o = player.Character:FindFirstChild("HumanoidRootPart")
            if o then minDist = math.min(minDist, (hrp.Position - o.Position).Magnitude) end
        end
    end
    return minDist
end

local function getPromptPosition(prompt)
    local p = prompt.Parent
    if p:IsA("Attachment") then return p.WorldPosition end
    if p:IsA("BasePart") then return p.Position end
    if p:IsA("Model") then
        local pr = p.PrimaryPart or p:FindFirstChildWhichIsA("BasePart")
        if pr then return pr.Position end
    end
    local f = p:FindFirstChildWhichIsA("BasePart", true)
    return f and f.Position or nil
end

local function findNearestStealPrompt()
    local char = LocalPlayer.Character
    if not char then return nil, math.huge end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil, math.huge end
    local nearest, minDist = nil, math.huge
    local plots = Workspace:FindFirstChild("Plots")
    if plots then
        for _, obj in ipairs(plots:GetDescendants()) do
            if obj:IsA("ProximityPrompt") and obj.Enabled and obj.ActionText == "Steal" then
                local pos = getPromptPosition(obj)
                if pos then
                    local dist = (hrp.Position - pos).Magnitude
                    if dist < minDist then minDist, nearest = dist, obj end
                end
            end
        end
    end
    return nearest, minDist
end

local function StartFloat()
    if IsCurrentlyFloating then return end
    local character = LocalPlayer.Character
    if not character then return end
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    
    IsCurrentlyFloating = true
    OriginalGroundY = GetRealGroundY(hrp)
    
    local currentHeight = GetCurrentFloatHeight(hrp)
    
    if FloatPlatform then FloatPlatform:Destroy() end
    FloatPlatform = Instance.new("Part")
    FloatPlatform.Size = Vector3.new(4, 0.5, 4)
    FloatPlatform.Anchored = true
    FloatPlatform.CanCollide = true
    FloatPlatform.Transparency = 1
    FloatPlatform.Name = "FloatPlatform"
    FloatPlatform.Parent = Workspace
    FloatPlatform.Position = Vector3.new(hrp.Position.X, hrp.Position.Y - 3, hrp.Position.Z)
    
    FloatConnection = RunService.Heartbeat:Connect(function(dt)
        if not IsCurrentlyFloating then return end
        if not FloatPlatform or not FloatPlatform.Parent then return end
        
        local character = LocalPlayer.Character
        if not character then return end
        local hrp = character:FindFirstChild("HumanoidRootPart")
        if not hrp then return end
        
        local targetHeight = GetCurrentFloatHeight(hrp)
        local targetPlatformY = OriginalGroundY + targetHeight - 3
        local currentY = FloatPlatform.Position.Y
        local diff = targetPlatformY - currentY
        
        local moveSpeed = 40
        
        local newY
        if math.abs(diff) < 0.1 then
            newY = targetPlatformY
        else
            local step = math.sign(diff) * math.min(math.abs(diff), dt * moveSpeed)
            newY = currentY + step
        end
        
        FloatPlatform.Position = Vector3.new(hrp.Position.X, newY, hrp.Position.Z)
    end)
end

local function StopFloat()
    IsCurrentlyFloating = false
    OriginalGroundY = nil
    if FloatConnection then 
        FloatConnection:Disconnect() 
        FloatConnection = nil 
    end
    if FloatPlatform then 
        FloatPlatform:Destroy() 
        FloatPlatform = nil 
    end
end

local function UpdateHitboxExpander(enabled)
    if HitboxConnection then HitboxConnection:Disconnect() HitboxConnection = nil end
    if enabled then
        HitboxConnection = RunService.RenderStepped:Connect(function()
            for _, player in pairs(Players:GetPlayers()) do
                if player ~= LocalPlayer and player.Character then
                    local hrp = player.Character:FindFirstChild("HumanoidRootPart")
                    if hrp then
                        hrp.Size = Vector3.new(12, 12, 12)
                        hrp.Transparency = 0.4
                        hrp.Color = Color3.fromRGB(138, 43, 226)
                        hrp.Material = Enum.Material.SmoothPlastic
                        hrp.CanCollide = false
                    end
                end
            end
        end)
    else
        for _, player in pairs(Players:GetPlayers()) do
            if player.Character then
                local hrp = player.Character:FindFirstChild("HumanoidRootPart")
                if hrp then
                    hrp.Size = Vector3.new(2, 2, 1)
                    hrp.Transparency = 1
                    hrp.CanCollide = true
                end
            end
        end
    end
end

local function FindBatTool()
    local character = LocalPlayer.Character
    if not character then return nil, false end
    local eq = character:FindFirstChild("Bat")
    if eq and eq:IsA("Tool") then return eq, true end
    local bp = LocalPlayer:FindFirstChild("Backpack")
    if bp then
        local bat = bp:FindFirstChild("Bat")
        if bat and bat:IsA("Tool") then return bat, false end
    end
    return nil, false
end

local function EquipBatBySlot()
    local bp = LocalPlayer:FindFirstChild("Backpack")
    if not bp then return end
    local slot = 0
    for _, tool in ipairs(bp:GetChildren()) do
        if tool:IsA("Tool") then
            slot = slot + 1
            if tool.Name == "Bat" then break end
        end
    end
    if slot > 0 and slot <= 9 then
        local keys = {Enum.KeyCode.One, Enum.KeyCode.Two, Enum.KeyCode.Three, Enum.KeyCode.Four, Enum.KeyCode.Five, Enum.KeyCode.Six, Enum.KeyCode.Seven, Enum.KeyCode.Eight, Enum.KeyCode.Nine}
        pcall(function()
            VirtualInputManager:SendKeyEvent(true, keys[slot], false, game)
            task.wait()
            VirtualInputManager:SendKeyEvent(false, keys[slot], false, game)
        end)
    end
end

local function SwingBat()
    pcall(function()
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 1)
        task.wait()
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 1)
    end)
end

task.spawn(function()
    while task.wait(BatSpamDelay) do
        if not AutoBatEnabled then continue end
        local bat, isEquipped = FindBatTool()
        if bat then
            if not isEquipped then EquipBatBySlot() else SwingBat() end
        end
    end
end)

task.spawn(function()
    while task.wait(0.05) do
        if not FloatStealEnabled then
            if IsCurrentlyFloating then StopFloat() end
            FloatStealStartTime = 0
            continue
        end
        
        local character = LocalPlayer.Character
        if not character then continue end
        local humanoid = character:FindFirstChild("Humanoid")
        local hrp = character:FindFirstChild("HumanoidRootPart")
        if not humanoid or not hrp then continue end
        
        local isStealing = humanoid.WalkSpeed <= 25
        local playerNearby = GetNearestPlayerDistance(hrp) <= SmartFloatRange
        
        if isStealing and FloatStealStartTime == 0 then
            FloatStealStartTime = tick()
        elseif not isStealing then
            FloatStealStartTime = 0
        end
        
        local delayPassed = FloatStealStartTime > 0 and (tick() - FloatStealStartTime) >= FloatStartDelay
        local shouldFloat = isStealing and playerNearby and delayPassed
        
        if shouldFloat then
            if IsCurrentlyFloating and FloatPlatform and FloatPlatform.Parent then
                local platformY = FloatPlatform.Position.Y
                local myY = hrp.Position.Y
                if myY < (platformY - 5) then
                    StopFloat()
                    task.wait(0.1)
                    StartFloat()
                end
            elseif not IsCurrentlyFloating then
                StartFloat()
            end
        else
            if IsCurrentlyFloating then
                StopFloat()
            end
        end
    end
end)

TrackConnection(RunService.Heartbeat:Connect(function()
    if not AutoGrabEnabled then
        GrabStartTime = 0
        CurrentGrabPrompt = nil
        return
    end
    
    local prompt, dist = findNearestStealPrompt()
    local inRange = dist <= AutoGrabRange
    
    if inRange and prompt and prompt.Parent and prompt.Enabled then
        if CurrentGrabPrompt ~= prompt then
            CurrentGrabPrompt = prompt
            GrabStartTime = tick()
            ProgFill.Size = UDim2.new(0, 0, 1, 0)
            ProgPercent.Text = "0%"
        end
        
        pcall(function() fireproximityprompt(prompt) end)
        
        local holdDuration = prompt.HoldDuration or 1
        if holdDuration <= 0 then holdDuration = 1 end
        local elapsed = tick() - GrabStartTime
        local progress = math.clamp(elapsed / holdDuration, 0, 1)
        
        ProgFill.Size = UDim2.new(progress, 0, 1, 0)
        ProgPercent.Text = math.floor(progress * 100) .. "%"
        StatusLabel.Text = "Stealing..."
        StatusLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
    else
        if CurrentGrabPrompt then
            StatusLabel.Text = "Stolen!"
            StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
            ProgFill.Size = UDim2.new(1, 0, 1, 0)
            ProgPercent.Text = "100%"
            
            -- NACH ERFOLGREICHEM GRAB: Auto Grab deaktivieren
            task.delay(0.2, function()
                SetAutoGrab(false)
                ProgFill.Size = UDim2.new(0, 0, 1, 0)
                ProgPercent.Text = "0%"
                StatusLabel.Text = "Disabled"
                StatusLabel.TextColor3 = Color3.fromRGB(255, 60, 60)
            end)
            
            CurrentGrabPrompt = nil
            GrabStartTime = 0
        end
    end
end))

TrackConnection(RunService.Heartbeat:Connect(function()
    if not SpeedBoostEnabled then return end
    local character = LocalPlayer.Character
    if not character then return end
    local hrp = character:FindFirstChild("HumanoidRootPart")
    local humanoid = character:FindFirstChild("Humanoid")
    if not hrp or not humanoid or humanoid.Health <= 0 then return end
    local state = humanoid:GetState()
    if state == Enum.HumanoidStateType.Physics or state == Enum.HumanoidStateType.Ragdoll or state == Enum.HumanoidStateType.FallingDown then return end
    local isStealing = humanoid.WalkSpeed <= 25
    local currentSpeed = isStealing and StealSpeed or NormalSpeed
    SpeedStatusLabel.Text = (isStealing and "STEALING - " or "NORMAL - ") .. tostring(currentSpeed)
    SpeedStatusLabel.TextColor3 = isStealing and Color3.fromRGB(255, 180, 50) or Color3.fromRGB(0, 200, 100)
    local moveDir = humanoid.MoveDirection
    if moveDir.Magnitude > 0.1 then
        local dir = moveDir.Unit
        hrp.AssemblyLinearVelocity = Vector3.new(dir.X * currentSpeed, hrp.AssemblyLinearVelocity.Y, dir.Z * currentSpeed)
    end
end))

local lastAntiRagdoll, lastAntiKnockback, lastWalkFling, lastAutoGrab = false, false, false, false
local lastFloatSteal, lastSpeedBoost, lastHitbox, lastAutoBat, lastTweenPanel = false, false, false, false, false

TrackConnection(RunService.Heartbeat:Connect(function()
    local ar, ak, wf, ag = GetAntiRagdoll(), GetAntiKnockback(), GetWalkFling(), GetAutoGrabFunc()
    local fs, sb, hb, ab, tp = GetFloatSteal(), GetSpeedBoost(), GetHitboxExp(), GetAutoBat(), GetTweenPanel()

    if ar ~= lastAntiRagdoll then
        if ar then EnableAntiRagdoll() else DisableAntiRagdoll() end
        lastAntiRagdoll = ar
    end
    if ak ~= lastAntiKnockback then
        if ak then EnableAntiKnockback() else DisableAntiKnockback() end
        lastAntiKnockback = ak
    end
    if wf ~= lastWalkFling then
        if wf then StartWalkFling() else KillWalkFling() end
        lastWalkFling = wf
    end
    if ag ~= lastAutoGrab then
        AutoGrabEnabled = ag
        GrabStartTime = 0
        CurrentGrabPrompt = nil
        StatusLabel.Text = ag and "Searching..." or "Disabled"
        StatusLabel.TextColor3 = ag and Color3.fromRGB(150, 150, 150) or Color3.fromRGB(255, 60, 60)
        ProgFill.Size = UDim2.new(0, 0, 1, 0)
        ProgPercent.Text = "0%"
        lastAutoGrab = ag
    end
    if fs ~= lastFloatSteal then
        FloatStealEnabled = fs
        if not fs then StopFloat() FloatStealStartTime = 0 end
        lastFloatSteal = fs
    end
    if sb ~= lastSpeedBoost then
        SpeedBoostEnabled = sb
        SpeedFrame.Visible = sb
        lastSpeedBoost = sb
    end
    if hb ~= lastHitbox then
        UpdateHitboxExpander(hb)
        lastHitbox = hb
    end
    if ab ~= lastAutoBat then
        AutoBatEnabled = ab
        lastAutoBat = ab
    end
    if tp ~= lastTweenPanel then
        if tp then
            loadstring(game:HttpGet("https://raw.githubusercontent.com/ima123-en/jaboilin123/refs/heads/main/a", true))()
        else
            pcall(function()
                if game.CoreGui:FindFirstChild("TweenPanel") then
                    game.CoreGui:FindFirstChild("TweenPanel"):Destroy()
                end
            end)
        end
        lastTweenPanel = tp
    end
end))

local function FullCleanup()
    CleanupAllConnections()
    KillWalkFling()
    DisableAntiRagdoll()
    DisableAntiKnockback()
    StopFloat()
    UpdateHitboxExpander(false)
    if FloatPlatform then FloatPlatform:Destroy() FloatPlatform = nil end
    pcall(function()
        if game.CoreGui:FindFirstChild("TweenPanel") then
            game.CoreGui:FindFirstChild("TweenPanel"):Destroy()
        end
    end)
    -- Cleanup global functions
    getgenv().SchmecktSetAutoGrab = nil
    getgenv().SchmecktGetAutoGrab = nil
end

CloseButton.MouseButton1Click:Connect(function()
    FullCleanup()
    ScreenGui:Destroy()
end)

TrackConnection(LocalPlayer.CharacterAdded:Connect(function()
    StopFloat()
    FloatStealStartTime = 0
    OriginalGroundY = nil
    GrabStartTime = 0
    CurrentGrabPrompt = nil
end))
